<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Company Details - Fraxy Match Deal Making 2026</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .hero-section {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 40px 0;
            margin-bottom: 30px;
        }

        .company-logo {
            max-width: 200px;
            max-height: 120px;
            object-fit: contain;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            background: white;
        }

        .detail-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .detail-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1.1rem;
            color: #212529;
            margin-bottom: 16px;
        }

        .badge-sector {
            font-size: 0.9em;
            padding: 8px 12px;
            margin: 0 4px 8px 0;
        }

        .back-link {
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-link:hover {
            color: #0d6efd;
        }
    </style>
</head>

<body>

    <div class="container my-4">
        <a href="directory.html" class="back-link">
            <i class="bi bi-arrow-left me-2"></i> Back to Directory
        </a>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Loading company details...</p>
    </div>

    <div id="activeContent" style="display: none;">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-auto text-center text-md-start mb-3 mb-md-0">
                        <div id="logoContainer"></div>
                    </div>
                    <div class="col">
                        <h1 class="fw-bold mb-2" id="companyName"></h1>
                        <div class="mb-3">
                            <span id="companyType" class="badge bg-secondary me-2"></span>
                            <span id="companyLocation" class="badge bg-info text-dark"></span>
                        </div>
                    </div>
                    <div class="col-md-auto mt-3 mt-md-0">
                        <div id="actionButtons" class="d-flex gap-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="row">
                <!-- Left Column: Main Info -->
                <div class="col-lg-8">
                    <div class="detail-card">
                        <h4 class="mb-4">About</h4>
                        <p id="companyAbout" class="text-secondary" style="white-space: pre-wrap; line-height: 1.6;">
                        </p>
                    </div>

                    <div class="detail-card">
                        <h4 class="mb-4">Targeted Investment Sectors</h4>
                        <div id="sectorList" class="d-flex flex-wrap"></div>
                    </div>
                </div>

                <!-- Right Column: Sidebar Info -->
                <div class="col-lg-4">
                    <div class="detail-card">
                        <h5 class="mb-3">Representative</h5>
                        <div class="detail-label">Name</div>
                        <div class="detail-value" id="repName"></div>

                        <div class="detail-label">Title / Sub-Type</div>
                        <div class="detail-value" id="repTitle"></div>
                    </div>

                    <div class="detail-card">
                        <h5 class="mb-3">Investment Details</h5>

                        <div class="detail-label">Round</div>
                        <div class="detail-value" id="invRound">—</div>

                        <div class="detail-label">Capital Sought / Cap</div>
                        <div class="detail-value" id="invCap">—</div>

                        <div class="detail-label">Geographic Preference</div>
                        <div class="detail-value" id="invGeo">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="errorContainer" style="display: none;">
        <div class="alert alert-danger text-center">
            <h4>Company Not Found</h4>
            <p>We couldn't find the requested company. It may have been removed or the link is incorrect.</p>
            <a href="index.html" class="btn btn-primary mt-2">Return to Directory</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.0/papaparse.min.js"></script>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_w4zEO3E8Ryhgi0aUPfDgIg7NBNScWfJzVmNGa5qmbgSU31oyfOLdc45OkuM1-tPC/exec";
        const config = {
            investor: {
                url: 'https://raw.githubusercontent.com/kahhin23/Financial-Website/main/working.csv',
                headerRow: 1, // Row 2
                dataStart: 2, // Row 3
                idCol: 'Company', // or 'Company '
                type: 'investor'
            },
            project: {
                url: 'https://raw.githubusercontent.com/kahhin23/Financial-Website/main/project-list.csv',
                headerRow: 2, // Row 3
                dataStart: 3, // Row 4
                idCol: 'Project Name',
                type: 'project'
            }
        };

        function consumeTokenIfInvestorViewingProject() {
            const userStr = localStorage.getItem('fraxyUser');
            if (!userStr) return;

            const user = JSON.parse(userStr);
            if (user.type !== 'investor') return;

            // Only consume when viewing a project
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type') || 'investor';

            if (type !== 'project') return;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({
                    action: "consumeToken",
                    email:  user.email
                })
            })
            .then(r => r.json())
            .then(data => {
                console.log("Consume response:", data);
                if (data.success) {
                user.tokens = data.tokens;
                localStorage.setItem('fraxyUser', JSON.stringify(user));
                // Optional: show toast / update UI with remaining tokens
                console.log(`Tokens remaining: ${data.tokens}`);
                } else {
                console.warn("Token consume failed:", data.message);
                // You could redirect or show message "No tokens left"
                }
            })
            .catch(err => console.error("Token API error", err));
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function renderDetail(row, type) {
            let title, subtitle, desc, logoHtml = '', badges = '', aboutLabel = 'About';
            let sectors = [];
            let repName = '—', repTitle = '—';
            let buttons = '';

            // --- Common Helper: Sector Parsing ---
            const parseSectors = (r) => {
                let s = [];
                // Boolean 'Y'
                Object.keys(r).forEach(k => {
                    if (r[k] === 'Y' && (
                        k.includes('Financial Technology') || k.includes('Deep Technology') ||
                        k.includes('Environment') || k.includes('Healthcare') ||
                        k.includes('Consumer') || k.includes('Entertainment') ||
                        k.includes('Manufacturing') || k.includes('Infrastructure') ||
                        k.includes('Agriculture') || k.includes('Education')
                    )) s.push(k);
                });
                // String summary
                if (s.length === 0 && r['Targeted Sector']) {
                    r['Targeted Sector'].split(',').forEach(x => s.push(x.trim()));
                }
                return [...new Set(s)].map(raw => {
                    // Cleanup
                    return raw.replace('Financial Technology', 'FinTech')
                        .replace('Deep Technology', 'Deep Tech')
                        .replace('Environment, Energy and Clean Technology', 'Clean Energy')
                        .replace('Healthcare Technology', 'HealthTech')
                        .replace('Digital Entertainment and Media', 'Media & Ent')
                        .replace('Manufacturing Technology', 'Manuf Tech')
                        .replace('Infrastructure and Real Estate Services', 'Infra & RE')
                        .replace('Food and Agriculture', 'Food & Ag')
                        .replace('Education', 'Education');
                });
            };


            if (type === 'investor') {
                // === Investor Mapping ===
                title = row.Company || row['Company '] || 'Unknown Company';
                subtitle = '';
                desc = row.About || 'No description available.';

                // Logo
                if (row.companyLogos?.trim()) {
                    logoHtml = `<img src="${row.companyLogos}" class="company-logo" alt="${title}">`;
                } else {
                    logoHtml = '<div class="company-logo d-flex align-items-center justify-content-center bg-light text-muted" style="width:120px;height:120px;">No Logo</div>';
                }

                // Badges
                const investorType = row['Company Type - \nInvestor / Others / Project Owner'] || row['Company Type - Investor / Others / Project Owner'];
                if (investorType) badges += `<span class="badge bg-secondary me-2">${investorType}</span>`;

                const loc = row.Location || row['Company Location'];
                if (loc) badges += `<span class="badge bg-info text-dark">${loc}</span>`;

                // Links
                if (row['Company Website']) buttons += `<a href="${row['Company Website']}" target="_blank" class="btn btn-outline-primary"><i class="bi bi-globe me-2"></i>Website</a> `;
                if (row['Social Media']) buttons += `<a href="${row['Social Media']}" target="_blank" class="btn btn-outline-secondary"><i class="bi bi-linkedin me-2"></i>Social</a>`;

                // Rep
                repName = row.Representative;
                repTitle = row['Representative Title'] || row['Company Sub-Type'];

                // Sidebar: Investment details (keep existing logic or simplified)
                // (Existing logic is fine, we just hide/show the container if needed)
                $('#investmentDetailsCard').show();

                // Sectors
                sectors = parseSectors(row);

            } else {
                // === Project Mapping ===
                title = row['Project Name'] || 'Unknown Project';
                subtitle = row['Company Name'] || '';
                desc = row['Project Dexcription'] || 'No description available.';

                // No logo usually for projects in this CSV, use generic or hide
                logoHtml = '<div class="company-logo d-flex align-items-center justify-content-center bg-light text-primary" style="width:120px;height:120px;"><i class="bi bi-briefcase fs-1"></i></div>';

                // Badges
                const loc = row['Project Location'];
                if (loc) badges += `<span class="badge bg-info text-dark">${loc}</span>`;

                // Links
                // Links
                // if (row['link']) buttons += `<a href="${row['link']}" target="_blank" class="btn btn-primary"><i class="bi bi-box-arrow-up-right me-2"></i>View Opportunity</a>`;

                // Rep
                repName = row['Project Representative'];
                repTitle = row['Representative Title'];

                // Sidebar: Hide investment details specific to investors if not relevant
                // But projects also have "Investment Capital", "Investment Round" columns
                $('#investmentDetailsCard').show();

                // Sectors
                sectors = parseSectors(row);
                aboutLabel = 'Project Description';
            }

            // --- Render to DOM ---
            document.title = `${title} - Details`;
            $('#companyName').text(title);
            if (subtitle) $('#companyName').after(`<h5 class="text-muted">${subtitle}</h5>`);

            $('#logoContainer').html(logoHtml);
            $('#companyType').parent().html(badges); // Replace the badge container content

            $('h4:contains("About")').text(aboutLabel);
            $('#companyAbout').text(desc);
            $('#actionButtons').html(buttons);

            // Rep
            $('#repName').text(repName || '—');
            $('#repTitle').text(repTitle || '—');

            // Sectors
            const sectorHtml = sectors.length
                ? sectors.map(s => `<span class="badge bg-light text-dark border badge-sector">${s}</span>`).join('')
                : '<span class="text-muted">No specific sectors listed</span>';
            $('#sectorList').html(sectorHtml);

            // Investment Details (Common fields mapping)
            // Round
            let rounds = [];
            ['Seed & Pre-Series A', 'Series A', 'Series B', 'Series C and Beyond', 'IPO'].forEach(k => { if (row[k] === 'Y') rounds.push(k); });
            if (row['Investment Round'] && row['Investment Round'] !== 'Y' && !rounds.includes(row['Investment Round'])) rounds.push(row['Investment Round']);
            $('#invRound').text(rounds.length ? rounds.join(', ') : '—');

            // Capital
            let caps = [];
            // ... (Capital logic is same, keys are same in both CSVs mostly)
            const capKeys = [
                "500,000 USD or below", "500,001 to 1,000,000 USD", "1,000,001 to 2,500,000 USD",
                "2,500,001 to 5,000,000 USD", "5,000,001 to 7,500,000 USD", "7,500,001 to 10,000,000 USD",
                "10,000,001 to 25,000,000 USD", "25,000,001 to 50,000,000 USD", "50,000,001 USD or above"
            ];
            capKeys.forEach(k => { if (row[k] === 'Y') caps.push(k); });
            if (caps.length === 0 && row['Investment Capital ']) caps.push(row['Investment Capital ']); // Note space in generic
            if (caps.length === 0 && row['Investment Capial / Capital Seek']) caps.push(row['Investment Capial / Capital Seek']);
            $('#invCap').text(caps.length ? caps.join(', ') : '—');

            // Geo (Only for investors usually, but check if projects have it? Projects don't seem to have geo pref)
            if (type === 'project') {
                $('#invGeo').parent().hide(); // Hide Geo for projects
            } else {
                $('#invGeo').parent().show();
                let geos = [];
                ['Asia', 'Europe', 'North America', 'Middle East', 'Australasia', 'Africa', 'South America'].forEach(region => {
                    if (row[region] === 'Y') geos.push(region);
                });
                $('#invGeo').text(geos.length ? geos.join(', ') : (row['Investment Geographical Preference'] || '—'));
            }

            $('#loading').hide();
            $('#activeContent').fadeIn();
            consumeTokenIfInvestorViewingProject();
        }

        // Load Data
        const targetId = getQueryParam('id') || getQueryParam('company'); // fallback
        const targetType = getQueryParam('type') || 'investor';

        // Select Config
        const activeConfig = config[targetType] || config['investor'];

        if (!targetId) {
            $('#loading').hide();
            $('#errorContainer').show();
        } else {
            Papa.parse(activeConfig.url, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function (results) {
                    const rawRows = results.data;
                    if (rawRows.length <= activeConfig.dataStart) {
                        $('#loading').hide();
                        $('#errorContainer').html('<h4>Error loading data</h4>').show();
                        return;
                    }

                    // Headers
                    const headers = rawRows[activeConfig.headerRow].map(h => (h || '').trim().replace(/\n/g, ' '));

                    // console.log('Headers:', headers);

                    // Find Match
                    let foundRow = null;

                    for (let i = activeConfig.dataStart; i < rawRows.length; i++) {
                        const rowArray = rawRows[i];
                        const obj = {};
                        rowArray.forEach((val, idx) => {
                            if (idx < headers.length && headers[idx]) {
                                obj[headers[idx]] = (val || '').trim();
                            }
                        });

                        const rowId = obj[activeConfig.idCol] || obj[activeConfig.idCol + ' '];
                        // console.log(`Checking ${rowId} vs ${targetId}`);
                        if (rowId === targetId) {
                            foundRow = obj;
                            break;
                        }
                    }

                    if (foundRow) {
                        renderDetail(foundRow, activeConfig.type);
                    } else {
                        $('#loading').hide();
                        $('#errorContainer').html('<h4>Entry Not Found</h4><p>We could not find the requested entry.</p>').show();
                    }
                },
                error: function (err) {
                    console.error(err);
                    $('#loading').hide();
                    $('#errorContainer').html('<h4>Connection Error</h4><p>Could not load data.</p>').show();
                }
            });
        }
    </script>

</body>

</html>